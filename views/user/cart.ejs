<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body>
<%- include('../components/header') %>
<section class="container mt-5" id="cartContainer">
    <h2>Your Shopping Cart</h2>
    <form action="/api/cart/buy" method="post">
        <div>
        </div>
    </form>
</section>
<div class="modal fade" id="thanksModal" tabindex="-1" aria-labelledby="thanksModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="thanksModalLabel">Successful</h5>
            </div>
            <div class="modal-body">
                Thanks!
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="window.location.href='/profile'">Continue</button>
            </div>
        </div>
    </div>
</div>
<%- include('../components/footer') %>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    axios.get('http://localhost:3000/api/cart/user')
        .then(response => {
            const userId = response.data.userId
            axios.get(`http://localhost:3000/api/cart/${userId}`)
                .then(response => {
                    const cart = response.data.cart
                    const cartContainer = document.getElementById('cartContainer')

                    if (cart && cart.productId && cart.productId.length > 0) {
                        const ul = document.createElement('ul')
                        ul.classList.add('list-group')

                        cart.productId.forEach(product => {
                            const li = document.createElement('li')
                            li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center')
                            li.innerHTML = `
                        ${product.title} - ${product.price}
                        <div class="form-outline" style="width: 22rem">
                            <input type="number" min="1" max="${product.quantity}" id="quantity" name="quantity"
                                   class="form-control"/>
                            <label class="form-label" for="quantity">Quantity</label>
                        </div>
                        <form action="/api/cart/remove/${product._id}" method="POST">
                            <button type="submit" class="btn btn-danger">Remove</button>
                        </form>
                    `
                            ul.appendChild(li)
                        })

                        const buyButton = document.createElement('button')
                        buyButton.classList.add('btn', 'btn-primary', 'mt-2')
                        buyButton.innerText = 'Buy'
                        buyButton.addEventListener('click', function () {
                            $('#thanksModal').modal('show')
                        })

                        const form = document.querySelector('form')
                        form.appendChild(ul)
                        form.appendChild(buyButton)
                    } else {
                        const p = document.createElement('p')
                        p.classList.add('mt-3')
                        p.innerText = 'Your cart is empty.'
                        cartContainer.appendChild(p)
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error)
                })
        })
        .catch(error => {
            console.error('Error fetching user ID:', error);
        })
</script>
</body>
</html>
